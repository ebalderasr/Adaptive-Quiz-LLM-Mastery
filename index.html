<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adaptive LLM Quiz ‚Äî LLM Mastery</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b0c0f;            /* used in dark */
      --card: #11131a;
      --text: #e8eaf0;
      --muted: #A3A9B8;
      --brand: #6ea8fe;
      --brand-2: #8bd3ff;
      --ok: #2ecc71;
      --warn:#f1c40f;
      --bad: #ff6b6b;
      --border: #2a2f3a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f8fb;
        --card: #ffffff;
        --text: #151823;
        --muted:#5b6070;
        --brand:#2458ff;
        --brand-2:#1ea7fd;
        --ok:#1a9d55;
        --warn:#c48a06;
        --bad:#d83a3a;
        --border:#e6e8ef;
        --shadow: 0 8px 24px rgba(25, 35, 60, .08);
      }
    }
    html,body{height:100%}
    body{
      margin:0; font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:var(--bg);
    }
    .container{max-width:1000px; margin:0 auto; padding:24px;}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
      background: color-mix(in lab, var(--bg) 70%, transparent);
      border-bottom:1px solid var(--border);
    }
    .header-inner{display:flex; align-items:center; gap:12px; padding:12px 24px;}
    .title{font-weight:800; letter-spacing:.2px; font-size: clamp(18px, 2.5vw, 22px)}
    .subtitle{color:var(--muted); font-size:14px}
    .spacer{flex:1}
    .btn{appearance:none; border:1px solid var(--border); background:linear-gradient(180deg, color-mix(in srgb, var(--card), transparent 5%), var(--card)); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow: var(--shadow); transition: transform .06s ease, border-color .2s ease;}
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px) scale(.98); }
    .btn.primary{ background: linear-gradient(180deg, var(--brand-2), var(--brand)); color:#fff; border-color: color-mix(in srgb, var(--brand), #000 10%) }
    .btn.ghost{ background: transparent; box-shadow:none }
    .grid{ display:grid; gap:16px }
    .grid.cols-2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 800px){ .grid.cols-2{ grid-template-columns: 1fr } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:20px; box-shadow: var(--shadow); overflow:hidden }
    .card .pad{ padding:20px }

    .row{ display:flex; align-items:center; gap:12px }

    .badge{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; background: color-mix(in srgb, var(--brand), transparent 80%); color: color-mix(in srgb, var(--brand), #000 20%); border:1px solid color-mix(in srgb, var(--brand), #000 85%); border-radius:999px }

    .progress{ height:10px; background: color-mix(in srgb, var(--text), transparent 92%); border-radius:999px; overflow:hidden; border:1px solid var(--border) }
    .progress > span{ display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--brand), var(--brand-2)); transition: width .3s ease }

    .qtext{ font-size: clamp(18px, 2.4vw, 22px); font-weight: 700; margin: 6px 0 12px }
    .meta{ color:var(--muted); font-size:13px }

    .options{ display:grid; gap:10px; margin-top:12px }
    .opt{ border:1px solid var(--border); border-radius:14px; background: linear-gradient(180deg, color-mix(in srgb, var(--card), transparent 4%), var(--card)); padding:14px; text-align:left; cursor:pointer; transition: border-color .2s ease, transform .06s ease }
    .opt:hover{ transform: translateY(-1px) }
    .opt[data-state="selected"]{ outline:3px solid color-mix(in srgb, var(--brand), transparent 30%); border-color: var(--brand) }
    .opt[data-state="correct"]{ border-color: var(--ok); background: color-mix(in srgb, var(--ok), transparent 90%) }
    .opt[data-state="wrong"]{ border-color: var(--bad); background: color-mix(in srgb, var(--bad), transparent 90%) }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:16px }

    .explain{ margin-top:12px; display:none; border:1px dashed var(--border); border-radius:12px; padding:12px; font-size:14px; background: color-mix(in srgb, var(--text), transparent 95%) }

    .pill{ border-radius:999px; padding:6px 10px; font-size:12px; border:1px solid var(--border); background: color-mix(in srgb, var(--text), transparent 95%) }

    .footer-nav{ display:flex; gap:10px; margin-top:12px; justify-content:space-between; align-items:center; }

    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; border: 1px solid var(--border); background: color-mix(in srgb, var(--text), transparent 92%); padding: 1px 6px; border-radius:6px; font-size: 12px }

    .toast{ position: fixed; inset-block-end: 18px; inset-inline: 0; display:flex; justify-content:center; pointer-events:none }
    .toast > div{ pointer-events:auto; max-width: 600px; margin: 0 16px; background: var(--card); color: var(--text); border:1px solid var(--border); border-radius: 14px; padding: 10px 14px; box-shadow: var(--shadow) }

    .stats{ display:grid; gap:12px; grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 800px){ .stats{ grid-template-columns: 1fr 1fr } }

    .stat{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; text-align:center }
    .stat .n{ font-weight:800; font-size:28px }
    .stat .l{ color:var(--muted); font-size:12px }

    .bar{ height: 10px; border-radius: 999px; background: color-mix(in srgb, var(--text), transparent 90%); overflow: hidden; border: 1px solid var(--border) }
    .bar > span{ display:block; height:100%; background: linear-gradient(90deg, var(--brand), var(--brand-2)); width:0 }

    .hidden{ display:none !important }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <div class="title">Adaptive LLM Quiz</div>
        <div class="subtitle">Dependency‚Äëfree ¬∑ Keyboard friendly ¬∑ Mobile ready</div>
      </div>
      <span class="spacer"></span>
      <button class="btn ghost" id="themeToggle" aria-label="Toggle theme">üåó Theme</button>
      <button class="btn ghost" id="helpBtn" aria-label="Help">‚ùì Help</button>
      <button class="btn" id="resetBtn" aria-label="Reset">‚Ü∫ Reset</button>
    </div>
  </header>

  <main class="container">
    <!-- START PANEL -->
    <section id="start" class="grid cols-2">
      <div class="card">
        <div class="pad">
          <h2 style="margin:0 0 6px">Welcome</h2>
          <p class="meta">This quiz adapts to your performance and avoids repeating questions. Use <span class="kbd">1..5</span> to answer and <span class="kbd">N</span> for ‚ÄúNext‚Äù.
          </p>
          <div class="grid" style="margin-top:12px">
            <label class="row" for="mode">
              <span class="pill">Mode</span>
              <select id="mode" class="btn" style="min-width:200px">
                <option value="adaptive">Adaptive (recommended)</option>
                <option value="practice">Practice</option>
                <option value="exam">Exam</option>
              </select>
            </label>
            <label class="row" for="nQuestions">
              <span class="pill">Questions</span>
              <input id="nQuestions" class="btn" type="number" min="5" max="100" value="20" />
            </label>
            <label class="row" for="shuffle">
              <span class="pill">Shuffle</span>
              <input id="shuffle" type="checkbox" checked />
            </label>
          </div>
          <div class="toolbar">
            <button id="startBtn" class="btn primary">Start quiz</button>
            <button id="importBtn" class="btn">Import questions (JSON)</button>
            <input id="fileInput" type="file" accept="application/json" class="hidden" />
          </div>
        </div>
      </div>
      <div class="card">
        <div class="pad">
          <h3 style="margin:0 0 6px">How adaptive scoring works</h3>
          <ul class="meta" style="margin:0 0 12px 18px">
            <li>Starts at medium difficulty; correct answers increase difficulty, wrong answers decrease it.</li>
            <li>Confidence slider boosts reward for correct high‚Äëconfidence answers and penalizes overconfidence.</li>
            <li>Final score weighs accuracy, difficulty reached, and consistency.</li>
          </ul>
          <div class="stats">
            <div class="stat">
              <div class="n" id="bankCount">0</div>
              <div class="l">Questions loaded</div>
            </div>
            <div class="stat">
              <div class="n" id="tagCount">0</div>
              <div class="l">Unique tags</div>
            </div>
            <div class="stat">
              <div class="n" id="estTime">~0m</div>
              <div class="l">Estimated time</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- QUIZ PANEL -->
    <section id="quiz" class="hidden">
      <div class="row" style="margin: 6px 0 12px">
        <div class="progress" style="flex:1"><span id="progressBar"></span></div>
        <span class="pill" id="counter">0/0</span>
      </div>

      <article class="card" aria-live="polite">
        <div class="pad">
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div class="row" style="gap:8px; flex-wrap:wrap">
              <span class="badge" id="difficulty">Medium</span>
              <span class="badge" id="tags">‚Äî</span>
            </div>
            <button class="btn ghost" id="flagBtn" aria-pressed="false" title="Flag for review">‚öë Flag</button>
          </div>

          <div class="qtext" id="qtext">Question text</div>
          <div id="qmeta" class="meta">Choose the best answer.</div>

          <div class="options" id="options" role="group" aria-label="Answer choices"></div>

          <div class="row" style="margin-top:10px; align-items:center; gap:12px">
            <span class="pill">Confidence</span>
            <input type="range" id="confidence" min="1" max="5" value="3" />
            <span class="meta" id="confValue">3/5</span>
            <button class="btn ghost" id="idkBtn" title="Mark as I don't know">I don‚Äôt know</button>
          </div>

          <div id="explain" class="explain"></div>

          <div class="footer-nav">
            <div class="row">
              <button class="btn" id="prevBtn" disabled>‚Üê Previous</button>
              <button class="btn primary" id="submitBtn">Submit</button>
              <button class="btn" id="nextBtn" disabled>Next ‚Üí</button>
            </div>
            <div class="meta">Shortcuts: <span class="kbd">1..5</span>, <span class="kbd">N</span>, <span class="kbd">P</span></div>
          </div>
        </div>
      </article>
    </section>

    <!-- SUMMARY PANEL -->
    <section id="summary" class="hidden">
      <div class="grid cols-2">
        <div class="card"><div class="pad">
          <h3 style="margin:0 0 6px">Your performance</h3>
          <div class="stats">
            <div class="stat"><div class="n" id="scorePct">0%</div><div class="l">Score</div></div>
            <div class="stat"><div class="n" id="peakDiff">‚Äî</div><div class="l">Peak difficulty</div></div>
            <div class="stat"><div class="n" id="acc">‚Äî</div><div class="l">Accuracy</div></div>
          </div>
          <div style="margin-top:14px">
            <div class="meta">Topic coverage</div>
            <div class="bar"><span id="coverageBar" style="width:0%"></span></div>
          </div>
          <div class="toolbar" style="margin-top:14px">
            <button class="btn" id="reviewFlagsBtn">Review flagged</button>
            <button class="btn primary" id="restartBtn">Restart</button>
            <button class="btn" id="exportBtn">Export session (JSON)</button>
          </div>
        </div></div>
        <div class="card"><div class="pad" id="reviewList">
          <h3 style="margin:0 0 6px">Answer review</h3>
          <div class="meta">Click an item to revisit.</div>
          <ol id="answers"></ol>
        </div></div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast" aria-live="polite"></div>

  <script>
  /**
   * ‚öôÔ∏è QUESTION BANK
   * Replace/extend this with your own items.
   * Each item: { id, q, options:[...], correct:0‚Äëbased index, tags:["topic"], difficulty:1..5, explanation }
   */
  const QUESTION_BANK = [
    { id: 'q1', q: 'Which prompt pattern best reduces hallucinations when asking for citations?',
      options: ['Zero‚Äëshot generation', 'Chain‚Äëof‚Äëthought disclosure', 'Ask for tool‚Äëverified retrieval first, then answer with citations', 'Use a persona'],
      correct: 2,
      tags: ['Hallucinations','Retrieval','Evaluation'], difficulty: 2,
      explanation: 'For factual tasks, retrieve authoritative sources (via a tool) before answering; require citations to reduce fabrication risk.' },
    { id: 'q2', q: 'In tool‚Äëaugmented LLMs, the main reason to separate the ‚Äúplanner‚Äù from the ‚Äútool executor‚Äù is‚Ä¶',
      options: ['Performance on math', 'Lower latency', 'Clearer control over side‚Äëeffects and iterative refinement', 'Cheaper training'],
      correct: 2,
      tags: ['Tools','Agents'], difficulty: 3,
      explanation: 'Planner/executor separation improves reliability and observability of multi‚Äëstep tool use.' },
    { id: 'q3', q: '‚ÄúSystem prompt‚Äù primarily controls‚Ä¶',
      options: ['Model temperature', 'Context length', 'Global behavior and constraints across the conversation', 'User authentication'],
      correct: 2,
      tags: ['Prompting','Roles'], difficulty: 1,
      explanation: 'System prompts set top‚Äëlevel instructions and style that persist unless overridden.' },
  ];

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STATE
  const state = {
    mode: 'adaptive',
    target: 20,
    asked: new Set(),
    history: [], // {id, choice, correct, difficulty, conf, ts}
    difficulty: 3,
    peakDiff: 3,
    flags: new Set(),
    current: null,
    pool: [...QUESTION_BANK],
  };

  // Elements
  const $ = sel => document.querySelector(sel);
  const startPanel = $('#start');
  const quizPanel = $('#quiz');
  const summaryPanel = $('#summary');
  const progressBar = $('#progressBar');
  const counter = $('#counter');
  const difficultyBadge = $('#difficulty');
  const tagsBadge = $('#tags');
  const qtext = $('#qtext');
  const options = $('#options');
  const explain = $('#explain');
  const conf = $('#confidence');
  const confValue = $('#confValue');
  const flagBtn = $('#flagBtn');

  // Start options
  $('#mode').addEventListener('change', e => state.mode = e.target.value);
  $('#nQuestions').addEventListener('input', e => state.target = +e.target.value);
  $('#shuffle').addEventListener('change', e => {/* handled on start */});

  $('#startBtn').addEventListener('click', startQuiz);
  $('#restartBtn')?.addEventListener('click', () => location.reload());
  $('#helpBtn').addEventListener('click', () => toast('Answer with 1..5, Submit, then Next. Use the confidence slider to self‚Äëassess.'));
  $('#resetBtn').addEventListener('click', () => { localStorage.removeItem('llm-quiz-session'); location.reload(); });
  $('#importBtn').addEventListener('click', () => $('#fileInput').click());
  $('#fileInput').addEventListener('change', handleImport);
  $('#exportBtn').addEventListener('click', exportSession);
  $('#reviewFlagsBtn').addEventListener('click', () => renderReview([...state.flags]));

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (quizPanel.classList.contains('hidden')) return;
    if (/^[1-5]$/.test(e.key)) {
      const idx = +e.key - 1; const btn = options.children[idx]; if (btn) btn.click();
    } else if (e.key.toLowerCase() === 'n') { $('#nextBtn').click(); }
      else if (e.key.toLowerCase() === 'p') { $('#prevBtn').click(); }
  });

  // Confidence UI
  conf.addEventListener('input', () => confValue.textContent = `${conf.value}/5`);

  // Theme toggle
  (function initTheme(){
    const stored = localStorage.getItem('theme');
    if (stored) document.documentElement.dataset.theme = stored;
    $('#themeToggle').onclick = () => {
      const cur = document.documentElement.dataset.theme === 'light' ? 'dark' : 'light';
      document.documentElement.dataset.theme = cur;
      localStorage.setItem('theme', cur);
    };
  })();

  // Init counters
  updateBankStats();

  function startQuiz(){
    // Shuffle pool if requested
    if ($('#shuffle').checked) state.pool.sort(() => Math.random() - .5);

    // Limit to target
    if (state.pool.length < state.target) state.target = state.pool.length;

    // Panels
    startPanel.classList.add('hidden');
    quizPanel.classList.remove('hidden');

    nextQuestion();
  }

  function pickQuestion(){
    // Filter out already asked
    const remaining = state.pool.filter(q => !state.asked.has(q.id));
    if (!remaining.length) return null;

    if (state.mode !== 'adaptive') return remaining[0];

    // Adaptive: pick nearest difficulty to current state
    const sorted = remaining.sort((a,b) => Math.abs(a.difficulty - state.difficulty) - Math.abs(b.difficulty - state.difficulty));
    return sorted[0];
  }

  function renderQuestion(q){
    state.current = q; state.asked.add(q.id);

    // Header meta
    difficultyBadge.textContent = ['Very easy','Easy','Medium','Hard','Very hard'][q.difficulty-1] || 'Medium';
    tagsBadge.textContent = q.tags?.join(' ¬∑ ') || '‚Äî';
    qtext.textContent = q.q;
    $('#qmeta').textContent = state.mode === 'exam' ? 'No instant feedback in Exam mode.' : 'Choose the best answer.';

    // Options
    options.innerHTML = '';
    q.options.forEach((text,i) => {
      const btn = document.createElement('button');
      btn.className = 'opt';
      btn.setAttribute('role','radio');
      btn.setAttribute('aria-checked','false');
      btn.innerHTML = `<span class="meta" style="margin-right:6px">${i+1}.</span> ${text}`;
      btn.onclick = () => selectOption(btn,i);
      options.appendChild(btn);
    });

    // Nav
    $('#prevBtn').disabled = state.history.length === 0;
    $('#nextBtn').disabled = true;
    $('#submitBtn').disabled = false;

    explain.style.display = 'none'; explain.textContent = '';
    conf.value = 3; confValue.textContent = '3/5';
    flagBtn.setAttribute('aria-pressed', state.flags.has(q.id) ? 'true' : 'false');

    // Progress
    const n = state.history.length; counter.textContent = `${Math.min(n+1, state.target)}/${state.target}`;
    progressBar.style.width = `${(n / state.target) * 100}%`;

    // Focus first option
    setTimeout(() => options.querySelector('.opt')?.focus(), 0);
  }

  function selectOption(btn, idx){
    [...options.children].forEach(el => { el.dataset.state=''; el.setAttribute('aria-checked','false') });
    btn.dataset.state='selected'; btn.setAttribute('aria-checked','true');
    state.current.choice = idx;
  }

  $('#submitBtn').addEventListener('click', () => {
    if (state.current?.choice == null && !$('#idkBtn').dataset.clicked) { toast('Pick an answer or press ‚ÄúI don‚Äôt know‚Äù.'); return; }

    const q = state.current;
    const choice = $('#idkBtn').dataset.clicked ? -1 : q.choice;
    const correct = choice === q.correct;

    // Instant feedback unless exam mode
    if (state.mode !== 'exam') {
      [...options.children].forEach((el, i) => {
        if (i === q.correct) el.dataset.state = 'correct';
        else if (i === choice) el.dataset.state = 'wrong';
        else el.dataset.state = '';
      });
      explain.style.display = 'block';
      explain.textContent = q.explanation || '';
    }

    // Score & difficulty update
    const confidence = +conf.value; const confFactor = 1 + (confidence-3)*0.1; // ¬±20%
    const delta = correct ? (0.6 * confFactor) : (-0.5 * (confidence>=4 ? 1.2 : 1));
    state.difficulty = clamp(1, 5, Math.round(state.difficulty + (correct ? 1 : -1)));
    state.peakDiff = Math.max(state.peakDiff, state.difficulty);

    state.history.push({ id:q.id, choice, correct, difficulty:q.difficulty, conf:confidence, ts:Date.now() });

    // Nav
    $('#submitBtn').disabled = true; $('#nextBtn').disabled = false; $('#prevBtn').disabled = state.history.length <= 1;

    // Reset IDK flag
    $('#idkBtn').dataset.clicked = '';

    // Progress
    const n = state.history.length; counter.textContent = `${Math.min(n, state.target)}/${state.target}`;
    progressBar.style.width = `${(n / state.target) * 100}%`;

    persist();
  });

  $('#nextBtn').addEventListener('click', nextQuestion);
  $('#prevBtn').addEventListener('click', () => revisit(state.history[state.history.length-2]?.id));

  $('#idkBtn').addEventListener('click', () => { $('#idkBtn').dataset.clicked = '1'; toast("Marked as 'I don't know'. You can still submit."); });
  flagBtn.addEventListener('click', () => {
    const id = state.current?.id; if (!id) return;
    if (state.flags.has(id)) state.flags.delete(id); else state.flags.add(id);
    flagBtn.setAttribute('aria-pressed', state.flags.has(id) ? 'true' : 'false');
  });

  function nextQuestion(){
    if (state.history.length >= state.target || state.asked.size >= state.pool.length){
      return finish();
    }
    const q = pickQuestion();
    if (!q) return finish();
    renderQuestion(q);
  }

  function revisit(id){
    const q = state.pool.find(x => x.id === id); if (!q) return;
    renderQuestion(q);
  }

  function finish(){
    quizPanel.classList.add('hidden');
    summaryPanel.classList.remove('hidden');

    const acc = state.history.length ? (state.history.filter(h=>h.correct).length / state.history.length) : 0;
    $('#acc').textContent = `${Math.round(acc*100)}%`;
    $('#peakDiff').textContent = ['‚Äî','Very easy','Easy','Medium','Hard','Very hard'][state.peakDiff] || '‚Äî';

    // Simple score: accuracy √ó (0.8 + 0.2 * peak difficulty ratio)
    const score = acc * (0.8 + 0.2 * (state.peakDiff/5));
    $('#scorePct').textContent = `${Math.round(score*100)}%`;

    // Coverage = unique tags hit / total tags
    const allTags = new Set(state.pool.flatMap(q=>q.tags||[]));
    const seenTags = new Set(state.history.map(h=> state.pool.find(q=>q.id===h.id)?.tags || []).flat());
    const coverage = allTags.size ? (seenTags.size / allTags.size) : 0;
    $('#coverageBar').style.width = `${Math.round(coverage*100)}%`;

    renderReview();
    persist();
    toast('Quiz complete! Review your answers below.');
  }

  function renderReview(onlyIds=null){
    const list = $('#answers'); list.innerHTML='';
    const records = state.history.map(h => ({...h, q: state.pool.find(x=>x.id===h.id)}));
    records.filter(r => !onlyIds || onlyIds.includes(r.id)).forEach((r, idx) => {
      const li = document.createElement('li'); li.style.marginBottom='10px';
      const user = r.choice === -1 ? 'I don\'t know' : r.q.options[r.choice] || '‚Äî';
      const correct = r.q.options[r.q.correct];
      li.innerHTML = `<div><strong>${idx+1}. ${r.q.q}</strong></div>
        <div class="meta">Your answer: <span style="color:${r.correct? 'var(--ok)':'var(--bad)'}">${user}</span> ¬∑ Correct: ${correct}</div>
        ${r.q.explanation ? `<div class="meta">${r.q.explanation}</div>`: ''}`;
      li.onclick = () => { summaryPanel.classList.add('hidden'); quizPanel.classList.remove('hidden'); revisit(r.id); };
      list.appendChild(li);
    });
  }

  function updateBankStats(){
    $('#bankCount').textContent = QUESTION_BANK.length;
    const allTags = new Set(QUESTION_BANK.flatMap(q=>q.tags||[]));
    $('#tagCount').textContent = allTags.size;
    $('#estTime').textContent = `~${Math.max(1, Math.round(QUESTION_BANK.length*0.5))}m`;
  }

  function handleImport(evt){
    const file = evt.target.files?.[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        if (!Array.isArray(data)) throw new Error('JSON must be an array of questions');
        if (!data.every(v => v && v.q && Array.isArray(v.options) && Number.isInteger(v.correct))) {
          throw new Error('Each item needs { q, options[], correct }');
        }
        state.pool = data.map((q, i) => ({ difficulty: 3, tags: [], explanation: '', id: q.id || `imp_${i}`, ...q }));
        state.asked.clear(); state.history = []; state.flags.clear();
        updateBankStats();
        toast(`Imported ${state.pool.length} questions.`);
      }catch(err){ toast('Import failed: '+ err.message); }
    };
    reader.readAsText(file);
  }

  function exportSession(){
    const out = { timestamp: new Date().toISOString(), mode: state.mode, target: state.target, history: state.history, flags: [...state.flags], bankSize: state.pool.length };
    const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'llm_quiz_session.json'; a.click(); URL.revokeObjectURL(url);
  }

  function toast(msg){
    const t = document.createElement('div'); t.innerHTML = `<div>${msg}</div>`;
    const host = $('#toast'); host.appendChild(t);
    setTimeout(() => { t.style.opacity='0'; t.style.transition='opacity .4s'; setTimeout(()=>t.remove(), 400); }, 2200);
  }

  function persist(){
    try{ localStorage.setItem('llm-quiz-session', JSON.stringify({ ...state, asked:[...state.asked], flags:[...state.flags] })); }catch(_){ }
  }

  (function restore(){
    try{
      const raw = localStorage.getItem('llm-quiz-session'); if (!raw) return;
      const saved = JSON.parse(raw);
      if (saved && Array.isArray(saved.pool)) {
        state.mode = saved.mode || state.mode;
        state.target = saved.target || state.target;
        state.asked = new Set(saved.asked||[]);
        state.history = saved.history||[];
        state.difficulty = saved.difficulty||3;
        state.peakDiff = saved.peakDiff||3;
        state.flags = new Set(saved.flags||[]);
        state.pool = saved.pool.length ? saved.pool : state.pool;
        updateBankStats();
        toast('Restored previous session.');
      }
    }catch(_){ }
  })();

  function clamp(min, max, v){ return Math.max(min, Math.min(max, v)); }

  // Start in start panel
  </script>
</body>
</html>
